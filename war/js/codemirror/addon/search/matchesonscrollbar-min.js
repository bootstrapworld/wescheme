(function(d){"object"==typeof exports&&"object"==typeof module?d(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],d):d(CodeMirror)})(function(d){function g(b,c,a,e){this.cm=b;this.options=e;var f={listenForChanges:!1},d;for(d in e)f[d]=e[d];f.className||(f.className="CodeMirror-search-match");this.annotation=b.annotateScrollbar(f);this.query=
c;this.caseFold=a;this.gap={from:b.firstLine(),to:b.lastLine()+1};this.matches=[];this.update=null;this.findMatches();this.annotation.update(this.matches);var g=this;b.on("change",this.changeHandler=function(a,b){g.onChange(b)})}d.defineExtension("showMatchesOnScrollbar",function(b,c,a){"string"==typeof a&&(a={className:a});a||(a={});return new g(this,b,c,a)});g.prototype.findMatches=function(){if(this.gap){for(var b=0;b<this.matches.length;b++){var c=this.matches[b];if(c.from.line>=this.gap.to)break;
c.to.line>=this.gap.from&&this.matches.splice(b--,1)}for(var a=this.cm.getSearchCursor(this.query,d.Pos(this.gap.from,0),this.caseFold),e=this.options&&this.options.maxMatches||1E3;a.findNext();){c={from:a.from(),to:a.to()};if(c.from.line>=this.gap.to)break;this.matches.splice(b++,0,c);if(this.matches.length>e)break}this.gap=null}};g.prototype.onChange=function(b){var c=b.from.line,a=d.changeEnd(b).line,e=a-b.to.line;this.gap?(this.gap.from=Math.min(this.gap.from<=c?this.gap.from:Math.max(c,this.gap.from+
e),b.from.line),this.gap.to=Math.max(this.gap.to<=c?this.gap.to:Math.max(c,this.gap.to+e),b.from.line)):this.gap={from:b.from.line,to:a+1};if(e)for(b=0;b<this.matches.length;b++){var a=this.matches[b],f=a.from.line<=c?a.from.line:Math.max(c,a.from.line+e);f!=a.from.line&&(a.from=d.Pos(f,a.from.ch));f=a.to.line<=c?a.to.line:Math.max(c,a.to.line+e);f!=a.to.line&&(a.to=d.Pos(f,a.to.ch))}clearTimeout(this.update);var g=this;this.update=setTimeout(function(){g.updateAfterChange()},250)};g.prototype.updateAfterChange=
function(){this.findMatches();this.annotation.update(this.matches)};g.prototype.clear=function(){this.cm.off("change",this.changeHandler);this.annotation.clear()}});
